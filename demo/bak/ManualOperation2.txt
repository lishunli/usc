package com.taifook.mtss.mss.integration.manualOperation;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.simple.SimpleJdbcTemplate;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import com.taifook.mtss.mss.instrument.model.EgiOgInstrument;

/**
 *
 * @author ShunLi
 */
public class ManualOperation {
    private static int dataSyncBatchSize = 100;

    private static final String EGIOG_DELETE_SQL = "Delete FROM MC_TMP_OG_INSTR ";

    private static final String EGIOG_ALL_DATE_SQL = "SELECT * FROM MC_TMP_OG_INSTR ";

    private static final String EGIOG_INSERT_SQL = "Insert into MC_TMP_OG_INSTR " + "(INSTR_CDE ,ISIN_CDE,LOT_SIZ,CCY_CDE,IS_SUSPD,IS_CCASS_SETL,HAS_STAMP,LST_DATE,DELIST_DATE,LST_STAT,PREV_CLOS_PRICE , "
            + "ENGLISH_INSTR_NAM ,BIG5_CHI_INSTR_NAM,GB_CHI_INSTR_NAM ,CALL_PUT_STAT ,STRK_PRICE,IS_CBBC,IS_WARRANT,CALL_PRICE,EXPR_DATE,WARRANT_UPPER_LVL_INSTR_CDE)" + " VALUES " + "(:INSTR_CDE ,:ISIN_CDE,:LOT_SIZ,:CCY_CDE,:IS_SUSPD,:IS_CCASS_SETL ,:HAS_STAMP,:LST_DATE,:DELIST_DATE,:LST_STAT,:PREV_CLOS_PRICE , "
            + ":ENGLISH_INSTR_NAM ,:BIG5_CHI_INSTR_NAM,:GB_CHI_INSTR_NAM  ,:CALL_PUT_STAT ,:STRK_PRICE,:IS_CBBC,:IS_WARRANT,:CALL_PRICE,:EXPR_DATE,:WARRANT_UPPER_LVL_INSTR_CDE)";

    @SuppressWarnings("unchecked")
    public static void main(String[] args) throws Exception {
        // SIT
        DriverManagerDataSource dataSourceFrom = new DriverManagerDataSource();
        dataSourceFrom.setUrl("jdbc:oracle:thin:@172.30.201.15:1521:mseub");
        dataSourceFrom.setDriverClassName("oracle.jdbc.driver.OracleDriver");
        dataSourceFrom.setUsername("mssqry");
        dataSourceFrom.setPassword("a0665");

        // Local SZ
        DriverManagerDataSource dataSourceTo = new DriverManagerDataSource();
        dataSourceTo.setUrl("jdbc:oracle:thin:@10.100.53.85:1521:cmn");
        dataSourceTo.setDriverClassName("oracle.jdbc.driver.OracleDriver");
        dataSourceTo.setUsername("mssapp");
        dataSourceTo.setPassword("commission");

        // // Local HK
        // DriverManagerDataSource dataSourceTo = new DriverManagerDataSource();
        // dataSourceTo.setUrl("jdbc:oracle:thin:@10.100.210.40:1521:mseda");
        // dataSourceTo.setDriverClassName("oracle.jdbc.driver.OracleDriver");
        // dataSourceTo.setUsername("mdev11");
        // dataSourceTo.setPassword("mdev11");

        SimpleJdbcTemplate jdbcTemplateFrom = new SimpleJdbcTemplate(dataSourceFrom);
        final SimpleJdbcTemplate jdbcTemplateTo = new SimpleJdbcTemplate(dataSourceTo);

        HashMap<String, Object> paramMap = new HashMap<String, Object>();

        // clear temp table first
        jdbcTemplateTo.update(EGIOG_DELETE_SQL, paramMap);

        RowMapper<EgiOgInstrument> rowMapper = new RowMapper<EgiOgInstrument>() {
            public EgiOgInstrument mapRow(ResultSet rs, int paramInt) throws SQLException {
                EgiOgInstrument egiOgInstr = new EgiOgInstrument();

                egiOgInstr.setInstrumentCode(rs.getString("INSTR_CDE"));
                egiOgInstr.setIsinCode(rs.getString("ISIN_CDE"));
                egiOgInstr.setLotSize(rs.getLong("LOT_SIZ"));
                egiOgInstr.setCcyCode(rs.getString("CCY_CDE"));
                egiOgInstr.setSuspend(rs.getString("IS_SUSPD"));
                egiOgInstr.setIsCcass(rs.getString("IS_CCASS_SETL"));
                egiOgInstr.setHasStamp(rs.getString("HAS_STAMP"));
                egiOgInstr.setListingDate(rs.getDate("LST_DATE"));
                egiOgInstr.setDelistingDate(rs.getDate("DELIST_DATE"));
                egiOgInstr.setListingStatus(rs.getString("LST_STAT"));
                egiOgInstr.setPreviousClosingPrice(rs.getLong("PREV_CLOS_PRICE"));
                egiOgInstr.setEngName(rs.getString("ENGLISH_INSTR_NAM"));
                egiOgInstr.setBig5Name(rs.getString("BIG5_CHI_INSTR_NAM"));
                egiOgInstr.setGbChineseName(rs.getString("GB_CHI_INSTR_NAM"));
                egiOgInstr.setCallPut(rs.getString("CALL_PUT_STAT"));
                egiOgInstr.setStrikePrice(rs.getLong("STRK_PRICE"));
                egiOgInstr.setExpiryDate(rs.getDate("EXPR_DATE"));
                egiOgInstr.setIsCBBC(rs.getString("IS_CBBC"));
                egiOgInstr.setIsWarrant(rs.getString("IS_WARRANT"));
                egiOgInstr.setCallablePrice(rs.getLong("CALL_PRICE"));
                egiOgInstr.setUpperLevelInstrumentSymbolCode(rs.getString("WARRANT_UPPER_LVL_INSTR_CDE"));

                System.out.println(String.format("%04d", paramInt) + " : " + egiOgInstr.toString());

                return egiOgInstr;
            }

        };
        List<EgiOgInstrument> egiList = jdbcTemplateFrom.query(EGIOG_ALL_DATE_SQL, rowMapper, paramMap);

        int size = egiList.size();

        for (int i = 0; i * dataSyncBatchSize < size; i++) {
            int fromIndex = i * dataSyncBatchSize;
            int toIndex = size - fromIndex > dataSyncBatchSize ? fromIndex + dataSyncBatchSize : size;

            List<EgiOgInstrument> subEgiList = egiList.subList(fromIndex, toIndex);

            List<Map<String, ?>> sqlParams = new ArrayList<Map<String, ?>>(subEgiList.size());
            for (EgiOgInstrument item : subEgiList) {
                Map<String, Object> param = new HashMap<String, Object>();
                sqlParams.add(param);

                param.put("INSTR_CDE", item.getInstrumentCode());
                param.put("ISIN_CDE", item.getIsinCode());
                param.put("LOT_SIZ", item.getLotSize());
                param.put("CCY_CDE", item.getCcyCode());
                param.put("IS_SUSPD", item.getSuspend());
                param.put("IS_CCASS_SETL", item.getIsCcass());
                param.put("HAS_STAMP", item.getHasStamp());
                param.put("LST_DATE", item.getListingDate());
                param.put("DELIST_DATE", item.getDelistingDate());
                param.put("LST_STAT", item.getListingStatus());
                param.put("PREV_CLOS_PRICE", item.getPreviousClosingPrice());
                param.put("ENGLISH_INSTR_NAM", item.getEngName());
                param.put("BIG5_CHI_INSTR_NAM", item.getBig5Name());
                param.put("GB_CHI_INSTR_NAM", item.getGbChineseName());
                param.put("CALL_PUT_STAT", item.getCallPut());
                param.put("STRK_PRICE", item.getStrikePrice());
                param.put("EXPR_DATE", item.getExpiryDate());
                param.put("IS_CBBC", item.getIsCBBC());
                param.put("IS_WARRANT", item.getIsWarrant());
                param.put("CALL_PRICE", item.getCallablePrice());
                param.put("WARRANT_UPPER_LVL_INSTR_CDE", item.getUpperLevelInstrumentSymbolCode());

            }

            jdbcTemplateTo.batchUpdate(EGIOG_INSERT_SQL, sqlParams.toArray(new Map[0]));
            System.out.println("batch insert from " + fromIndex + " to " + toIndex);

        }
    }
}
